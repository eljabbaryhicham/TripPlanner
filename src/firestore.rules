
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    function isAdmin() { return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)); }
    function isSuperAdmin() { return isAdmin() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.role == 'superadmin'; }

    // --- User-specific data (Private) ---
    match /users/{userId} {
      // User can create, read, and update their own doc
      allow create, get, update: if isOwner(userId);
      // Admin can read any user doc (needed for subcollection writes)
      allow get: if isAdmin();
      // Only admins can list/delete users
      allow list, delete: if isAdmin();
      
      // Subcollections
      match /reservations/{reservationId} { allow read, write: if isOwner(userId) || isAdmin(); }
      match /serviceSuggestions/{suggestionId} { allow read, write: if isOwner(userId) || isAdmin(); }
    }

    // --- Admin Roles (Private) ---
    match /roles_admin/{adminId} {
      allow read, write: if isSuperAdmin();
      allow create: if isOwner(adminId); // Allows first admin to create their own role
      allow get: if isOwner(adminId);
    }
    
    // --- Inquiries (Private Read) ---
    match /inquiries/{inquiryId} {
      allow create: if isSignedIn();
      allow read, update, delete: if isAdmin();
    }
    
    // --- Generic rule for all public collections ---
    // This allows public read access to any collection not explicitly private.
    // New service collections (e.g., 'villas', 'tours') will automatically be public.
    match /{publicCollection}/{docId} {
        allow read: if publicCollection != 'users' 
                     && publicCollection != 'roles_admin' 
                     && publicCollection != 'inquiries';
        
        // Admins can write to any of these public collections.
        allow write: if isAdmin();

        // Special write rule for the 'reviews' collection.
        allow create: if publicCollection == 'reviews' 
                       && isSignedIn() 
                       && request.resource.data.userId == request.auth.uid;
        allow update, delete: if publicCollection == 'reviews' 
                               && (isOwner(resource.data.userId) || isAdmin());
    }
  }
}
