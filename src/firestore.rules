rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() { return request.auth != null; }
    function isOwner(userId) { return isSignedIn() && request.auth.uid == userId; }
    function isAdmin() { return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)); }
    function isSuperAdmin() { return isAdmin() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.role == 'superadmin'; }

    // --- Inquiries (Manual Bookings) ---
    match /inquiries/{inquiryId} {
      // Anyone can create an inquiry (including anonymous users)
      allow create: if isSignedIn();
      // Only admins can read or modify inquiries
      allow read, update, delete: if isAdmin();
    }

    // --- Public Collections (Readable by all, Writable by Admins) ---
    match /hotels/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /carRentals/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /transports/{docId} { allow read: if true; allow write: if isAdmin(); }
    match /exploreTrips/{docId} { allow read: if true; allow write: if isAdmin(); }

    // --- Publicly readable reviews ---
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
    }
    
    // --- User-specific data ---
    match /users/{userId} {
      // User can create, read, and update their own doc
      allow create, get, update: if isOwner(userId);
      // Admin can read any user doc (needed for subcollection writes)
      allow get: if isAdmin();
      // Only admins can list/delete users
      allow list, delete: if isAdmin();
    }

    // --- User Reservations (subcollection) ---
    match /users/{userId}/reservations/{reservationId} {
      // A user can manage their own reservations.
      // An admin can manage any user's reservations.
      allow read, write: if isOwner(userId) || isAdmin();
    }
    
    // --- Admin Roles ---
    match /roles_admin/{adminId} {
      // Superadmins can manage all admin roles
      allow read, write: if isSuperAdmin();
      // A user can create their own doc to request admin access
      allow create: if isOwner(adminId);
      // An admin can read their own role document
      allow get: if isOwner(adminId);
    }
  }
}
