
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the foundation of the user-ownership security model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * For state-changing operations (update, delete), ensures the user is the
     * owner AND the document already exists. This prevents writes to
     * non-existent paths.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * On create, validates that the new User document's internal `id` field
     * matches the document ID ({userId}), enforcing data consistency.
     */
    function hasValidUserDataOnCreate(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * On update, ensures the User's `id` field is immutable, preventing
     * the ownership link from being changed after creation.
     */
    function hasImmutableUserData() {
      return request.resource.data.id == resource.data.id;
    }
    
    /**
     * On create, validates that the new Reservation document's internal `userId`
     * field matches the {userId} from the path, creating an immutable
     * ownership record.
     */
    function hasValidReservationDataOnCreate(userId) {
      return request.resource.data.userId == userId;
    }

    /**
     * On update, ensures the Reservation's `userId` field is immutable.
     */
    function hasImmutableReservationData() {
      return request.resource.data.userId == resource.data.userId;
    }

    // --------------------------------------------------------------------
    // User Data Rules
    // --------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document.
     * @path /users/{userId}
     * @allow (create) An authenticated user can create their own profile document.
     * @allow (get, update, delete) The owner of the profile can read, update, or delete it.
     * @deny (list) Listing all users is forbidden to prevent user enumeration.
     * @deny (get) A user cannot read another user's profile.
     * @principle Restricts access to a user's own data tree and prevents data leakage.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && hasValidUserDataOnCreate(userId);
      allow update: if isExistingOwner(userId) && hasImmutableUserData();
      allow delete: if isExistingOwner(userId);
    }
    
    match /reservations/{reservationId} {
      allow read: if true;
      allow write: if true;
    }

    // --------------------------------------------------------------------
    // Public Service Catalog Rules
    // --------------------------------------------------------------------

    /**
     * @description Provides public, read-only access to the car rental catalog.
     * @path /carRentals/{carRentalId}
     * @allow (get, list) Any client, authenticated or not, can read the car rental listings.
     * @deny (create, update, delete) All write operations from clients are forbidden.
     * @principle Protects public data integrity by making it read-only for clients. Writes are assumed to be handled by a trusted backend.
     */
    match /carRentals/{carRentalId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Provides public, read-only access to the hotel catalog.
     * @path /hotels/{hotelId}
     * @allow (get, list) Any client, authenticated or not, can read the hotel listings.
     * @deny (create, update, delete) All write operations from clients are forbidden.
     * @principle Protects public data integrity by making it read-only for clients. Writes are assumed to be handled by a trusted backend.
     */
    match /hotels/{hotelId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Provides public, read-only access to the transport services catalog.
     * @path /transports/{transportId}
     * @allow (get, list) Any client, authenticated or not, can read the transport service listings.
     * @deny (create, update, delete) All write operations from clients are forbidden.
     * @principle Protects public data integrity by making it read-only for clients. Writes are assumed to be handled by a trusted backend.
     */
    match /transports/{transportId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
